name: Build and Test IRSSG Cross-Platform Wheels

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                             ğŸ› ï¸  å¼€å‘è€…é…ç½®åŒºåŸŸ                                    â•‘
# â•‘                         Developer Configuration                              â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 
# ğŸ æ”¯æŒçš„Pythonç‰ˆæœ¬ (ä¿®æ”¹æ­¤å¤„ä»¥æ›´æ”¹æ„å»ºçš„Pythonç‰ˆæœ¬)
# æ ¼å¼: {major}.{minor} (ä¾‹å¦‚: 3.9 = Python 3.9.x, 3.10 = Python 3.10.x)
# 
# ğŸ“ ä½¿ç”¨è¯´æ˜:
# - è¦æ„å»ºç‰¹å®šç‰ˆæœ¬: ä¿®æ”¹ PYTHON_VERSIONS_SOURCE
# - è¦è·³è¿‡æŸç‰ˆæœ¬: ä»åˆ—è¡¨ä¸­åˆ é™¤å¯¹åº”æ¡ç›®
# - è¦æ·»åŠ æ–°ç‰ˆæœ¬: åœ¨åˆ—è¡¨ä¸­æ·»åŠ  {ç‰ˆæœ¬å·}
# 
# ğŸ’¡ ç¤ºä¾‹:
# - åªæ„å»º 3.9-3.11: "3.9 3.10 3.11"
# - åªæ„å»º 3.10: "3.10"
# - æ„å»ºæ‰€æœ‰: "3.9 3.10 3.11 3.12 3.13"
# 
env:
  # ğŸ¯ Pythonç‰ˆæœ¬é…ç½® - åªéœ€è¦åœ¨è¿™é‡Œä¿®æ”¹ä¸€æ¬¡ï¼
  PYTHON_VERSIONS_SOURCE: "3.9 3.10 3.11"  # ä¸»ç‰ˆæœ¬åˆ—è¡¨ï¼Œç©ºæ ¼åˆ†éš”
  
  # å…¶ä»–æ„å»ºé…ç½®
  BUILD_VERBOSITY: "3"                    # æ„å»ºè¯¦ç»†åº¦ (0-3, æ¨è3ç”¨äºè°ƒè¯•)
  MACOS_DEPLOYMENT_TARGET: "15.0"         # macOSæœ€ä½ç‰ˆæœ¬è¦æ±‚ (æ”¯æŒApple Silicon)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  setup:
    name: Generate Python version configurations
    runs-on: ubuntu-latest
    outputs:
      python-versions-cibw: ${{ steps.config.outputs.python-versions-cibw }}
      python-versions-test: ${{ steps.config.outputs.python-versions-test }}
    steps:
      - name: Generate configurations
        id: config
        run: |
          # ä»ç¯å¢ƒå˜é‡è¯»å–æºç‰ˆæœ¬åˆ—è¡¨
          SOURCE_VERSIONS="${{ env.PYTHON_VERSIONS_SOURCE }}"
          echo "Source Python versions: $SOURCE_VERSIONS"
          
          # ç”Ÿæˆ cibuildwheel æ ¼å¼: "cp39-* cp310-* cp311-*"
          CIBW_VERSIONS=""
          for version in $SOURCE_VERSIONS; do
            major_minor=$(echo $version | tr -d '.')
            CIBW_VERSIONS="$CIBW_VERSIONS cp${major_minor}-*"
          done
          CIBW_VERSIONS=$(echo $CIBW_VERSIONS | sed 's/^ *//')
          echo "python-versions-cibw=$CIBW_VERSIONS" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆæµ‹è¯•çŸ©é˜µæ ¼å¼: ["3.9", "3.10", "3.11"]
          TEST_VERSIONS=$(echo "$SOURCE_VERSIONS" | sed 's/ /", "/g' | sed 's/^/["/' | sed 's/$/"]/')
          echo "python-versions-test=$TEST_VERSIONS" >> $GITHUB_OUTPUT
          
          echo "Generated configurations:"
          echo "  CIBW: $CIBW_VERSIONS"
          echo "  Test: $TEST_VERSIONS"

  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: setup
    strategy:
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            cibw_archs: x86_64
            
          # macOS ARM64 (Apple Silicon)
          - os: macos-latest  
            cibw_archs: arm64
            
          # Windows AMD64
          - os: windows-latest
            cibw_archs: AMD64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      # macOS: å®‰è£… Homebrew ä¾èµ–
      # macOSä¾èµ–ç°åœ¨åœ¨CIBW_BEFORE_BUILD_MACOSä¸­å¤„ç†
      # åˆ é™¤æ—§çš„macOSä¾èµ–å®‰è£…æ­¥éª¤ï¼Œé¿å…ä¸OpenBLASç­–ç•¥å†²çª
      
      # Windows: å®‰è£… MSYS2 å’Œ UCRT64 å·¥å…·é“¾
      - name: Install MSYS2 (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "Installing MSYS2 on Windows..."
          # ä¸‹è½½å¹¶å®‰è£… MSYS2
          powershell -Command "Invoke-WebRequest 'https://github.com/msys2/msys2-installer/releases/download/2024-01-13/msys2-x86_64-20240113.exe' -OutFile msys2-installer.exe"
          start /wait msys2-installer.exe --accept-messages --accept-licenses --confirm-command
          del msys2-installer.exe
          
          # è®¾ç½® MSYS2 ç¯å¢ƒ
          echo "C:\msys64\usr\bin" >> $GITHUB_PATH
          echo "C:\msys64\ucrt64\bin" >> $GITHUB_PATH
          
          # å®‰è£…å¿…è¦çš„åŒ…
          C:\msys64\usr\bin\pacman.exe -Syu --noconfirm
          C:\msys64\usr\bin\pacman.exe -S --noconfirm mingw-w64-ucrt-x86_64-gcc mingw-w64-ucrt-x86_64-gcc-fortran mingw-w64-ucrt-x86_64-lapack
          
          # éªŒè¯å®‰è£…
          echo "Verifying MSYS2 installation..."
          C:\msys64\ucrt64\bin\gfortran.exe --version
          C:\msys64\ucrt64\bin\gcc.exe --version
      

      
      - name: Build wheels
        uses: pypa/cibuildwheel@v2.21.3
        with:
          output-dir: wheelhouse
        env:
          # ğŸ Pythonç‰ˆæœ¬é…ç½® (ä½¿ç”¨åŠ¨æ€ç”Ÿæˆçš„ç‰ˆæœ¬)
          CIBW_BUILD: ${{ needs.setup.outputs.python-versions-cibw }}
          
          # å¹³å°ç‰¹å®šçš„æ¶æ„é…ç½®
          CIBW_ARCHS_LINUX: ${{ matrix.cibw_archs }}
          CIBW_ARCHS_MACOS: ${{ matrix.cibw_archs }}  
          CIBW_ARCHS_WINDOWS: ${{ matrix.cibw_archs }}
          
          # æ„å»ºè¯¦ç»†åº¦é…ç½®
          CIBW_BUILD_VERBOSITY: ${{ env.BUILD_VERBOSITY }}
          
          # macOSéƒ¨ç½²ç›®æ ‡é…ç½® (ä½¿ç”¨é¡¶éƒ¨envä¸­å®šä¹‰çš„ç‰ˆæœ¬)
          CIBW_ENVIRONMENT_MACOS: ${{ matrix.cibw_archs == 'arm64' && format('MACOSX_DEPLOYMENT_TARGET={0}', env.MACOS_DEPLOYMENT_TARGET) || '' }}
          
          # Linux: åœ¨manylinuxé•œåƒä¸­å®‰è£…ä¾èµ–
          CIBW_BEFORE_BUILD_LINUX: |
            set -e
            echo "ğŸ“¦ Installing dependencies in manylinux environment..."
            
            # å®‰è£…è¿è¡Œæ—¶ä¾èµ–å’Œæ•°å­¦åº“
            yum install -y rdma-core-devel || echo "Warning: Could not install RDMA dependencies"
            yum install -y lapack-devel || echo "Warning: Could not install LAPACK"
            
            # ä¿®å¤ libgfortran ç‰ˆæœ¬ä¸åŒ¹é…é—®é¢˜
            echo "ğŸ”§ Installing compatible gfortran runtime libraries..."
            yum install -y gcc-gfortran libgfortran || echo "Warning: Could not install gfortran runtime"
            
            # åˆ›å»º libgfortran.so.3 åˆ° libgfortran.so.5 çš„å…¼å®¹é“¾æ¥
            if [ -f /usr/lib64/libgfortran.so.5 ] && [ ! -f /usr/lib64/libgfortran.so.3 ]; then
              echo "Creating libgfortran.so.3 compatibility link..."
              ln -sf libgfortran.so.5 /usr/lib64/libgfortran.so.3
            fi
            
            # è®¾ç½®åº“è·¯å¾„ç¯å¢ƒå˜é‡
            export LD_LIBRARY_PATH="/usr/lib64:/usr/local/lib64:$LD_LIBRARY_PATH"
            export PKG_CONFIG_PATH="/usr/lib64/pkgconfig:/usr/local/lib64/pkgconfig:$PKG_CONFIG_PATH"
            
            # éªŒè¯æ•°å­¦åº“å®‰è£…
            echo "ğŸ” Installed math libraries:"
            ls -la /usr/lib64/liblapack* || echo "LAPACK not found"
            ls -la /usr/lib64/libgfortran* || echo "gfortran runtime not found"
            
            # éªŒè¯LAPACKå‡½æ•°å¯ç”¨æ€§
            echo "ğŸ” Verifying LAPACK functions..."
            if [ -f /usr/lib64/liblapack.so ]; then
              echo "âœ… LAPACK library found"
              nm -D /usr/lib64/liblapack.so | grep -i zheev || echo "âš ï¸  zheev function not found in LAPACK"
            else
              echo "âŒ LAPACK library not found"
            fi
            
            # ç¡®ä¿pkg-configèƒ½æ‰¾åˆ°åº“
            echo "ğŸ”§ Setting up pkg-config..."
            
            if [ -f /usr/lib64/pkgconfig/lapack.pc ]; then
              echo "âœ… LAPACK pkg-config file found"
            else
              echo "âš ï¸  LAPACK pkg-config file not found, creating one..."
              cat > /usr/lib64/pkgconfig/lapack.pc << EOF
            prefix=/usr
            libdir=/usr/lib64
            includedir=/usr/include
            
            Name: LAPACK
            Description: LAPACK is a library of linear algebra routines
            Version: 3.9.0
            Libs: -L\${libdir} -llapack
            Cflags: -I\${includedir}
            Requires: blas
            EOF
            fi
            

            
            echo "âœ… Dependencies installed successfully"
          
          # macOS: å®‰è£…ä¾èµ–å¹¶è®¾ç½®ç¼–è¯‘å™¨ (ç®€åŒ–ç‰ˆæœ¬ï¼Œåªç”¨LAPACK)
          CIBW_BEFORE_BUILD_MACOS: |
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡ºï¼Œä¾¿äºè°ƒè¯•
            echo "ğŸ“¦ Installing dependencies for macOS builds..."
            echo "ğŸ” Script started at: $(date)"
            echo "ğŸ” Current working directory: $(pwd)"
            echo "ğŸ” Current user: $(whoami)"
            echo "ğŸ” Current PATH: $PATH"
            
            # æ­¥éª¤1: æ›´æ–°Homebrew
            echo "Step 1: Updating Homebrew..."
            # brew update || { echo "âŒ Homebrew update failed"; exit 1; }
            
            # æ­¥éª¤2: å®‰è£…ä¾èµ– (ç®€åŒ–ç‰ˆæœ¬ï¼Œåªç”¨å¿…è¦çš„åŒ…)
            echo "Step 2: Installing dependencies (simplified)..."
            echo "Installing: gcc lapack (only essential packages)"
            brew install gcc lapack || { echo "âŒ Dependencies installation failed"; exit 1; }
            
            # ç¡®ä¿gfortranåœ¨PATHä¸­
            echo "$(brew --prefix)/bin" >> $GITHUB_PATH
            export PATH="$(brew --prefix)/bin:$PATH"
            
            # åˆ›å»ºgfortranè½¯é“¾æ¥ï¼ˆè§£å†³ç‰ˆæœ¬åŒ–gfortrané—®é¢˜ï¼‰
            echo "ğŸ”§ Creating gfortran symlink..."
            if [ ! -L "$(brew --prefix)/bin/gfortran" ]; then
              # æ‰¾åˆ°æœ€æ–°çš„gfortranç‰ˆæœ¬
              latest_gfortran=$(ls -1 $(brew --prefix)/bin/gfortran-* | sort -V | tail -1)
              if [ -n "$latest_gfortran" ]; then
                echo "Creating symlink: gfortran -> $(basename $latest_gfortran)"
                ln -sf $(basename $latest_gfortran) $(brew --prefix)/bin/gfortran
              else
                echo "âŒ No gfortran versions found"
                exit 1
              fi
            else
              echo "âœ… gfortran symlink already exists"
            fi
            
            echo "ğŸ” PATH after update: $PATH"
            echo "ğŸ” GITHUB_PATH content:"
            cat $GITHUB_PATH || echo "GITHUB_PATH not accessible"
            
            echo "âœ… Dependencies installed successfully (simplified)"
            
            # æ­¥éª¤3: è®¾ç½®ç¼–è¯‘å™¨ç¯å¢ƒå˜é‡
            echo "Step 3: Setting compiler environment variables..."
            
            # éªŒè¯gfortranæ˜¯å¦å¯ç”¨ (wanniertools style)
            echo "ğŸ” Verifying gfortran installation (wanniertools style)..."
            
            # ç®€å•éªŒè¯gfortran (åƒwanniertoolsä¸€æ ·)
            which gfortran || { echo "âŒ gfortran not found in PATH"; exit 1; }
            gfortran --version || { echo "âŒ gfortran version check failed"; exit 1; }
            echo "âœ… gfortran found: $(which gfortran)"
            
            export FC=$(brew --prefix)/bin/gfortran
            export CC=clang
            export CXX=clang++
            export FFLAGS="-fallow-invalid-boz -fbackslash -ffree-line-length-none -fallow-argument-mismatch"
            echo "âœ… Compiler variables set: FC=$FC, CC=$CC, CXX=$CXX"
            
            # æ­¥éª¤4: è®¾ç½®LAPACKè·¯å¾„
            echo "Step 4: Setting LAPACK paths..."
            export LDFLAGS="-L$(brew --prefix)/opt/lapack/lib"
            export CPPFLAGS="-I$(brew --prefix)/opt/lapack/include"
            export PKG_CONFIG_PATH="$(brew --prefix)/opt/lapack/lib/pkgconfig:$PKG_CONFIG_PATH"
            echo "âœ… LAPACK paths set: LDFLAGS=$LDFLAGS, CPPFLAGS=$CPPFLAGS"
            
            # æ­¥éª¤5: è®¾ç½®æ¶æ„æ ‡å¿—
            echo "Step 5: Setting architecture flags..."
            if [ "$(uname -m)" = "arm64" ]; then
              echo "ğŸ¯ Building for ARM64 (Apple Silicon)"
              export CFLAGS="-arch arm64"
              export CXXFLAGS="-arch arm64"
              export LDFLAGS="$LDFLAGS -arch arm64 -Wl,-rpath,$(brew --prefix)/opt/lapack/lib"
              export ARCHFLAGS="-arch arm64"
            else
              echo "ğŸ¯ Building for x86_64 (Intel)"
              export CFLAGS="-arch x86_64"
              export CXXFLAGS="-arch x86_64"
              export LDFLAGS="$LDFLAGS -arch x86_64 -Wl,-rpath,$(brew --prefix)/opt/lapack/lib"
              export ARCHFLAGS="-arch x86_64"
            fi
            echo "âœ… Architecture flags set: CFLAGS=$CFLAGS, CXXFLAGS=$CXXFLAGS"
            
            # æ­¥éª¤6: éªŒè¯å®‰è£…
            echo "Step 6: Verifying installation..."
            echo "ğŸ” Checking LAPACK library files..."
            ls -la $(brew --prefix)/opt/lapack/lib/ || { echo "âŒ LAPACK lib directory not found"; exit 1; }
            ls -la $(brew --prefix)/opt/lapack/include/ || { echo "âŒ LAPACK include directory not found"; exit 1; }
            
            echo "ğŸ” Checking pkg-config LAPACK detection..."
            pkg-config --exists lapack || { echo "âŒ pkg-config cannot find LAPACK"; exit 1; }
            pkg-config --modversion lapack || echo "âš ï¸ Could not get LAPACK version"
            pkg-config --variable=libdir lapack || echo "âš ï¸ Could not get LAPACK libdir"
            
            # æ­¥éª¤7: è®¾ç½®cibuildwheelç¯å¢ƒå˜é‡
            echo "Step 7: Setting cibuildwheel environment variables..."
            export CIBW_ENVIRONMENT_MACOS="LDFLAGS=$LDFLAGS CPPFLAGS=$CPPFLAGS PKG_CONFIG_PATH=$PKG_CONFIG_PATH MACOSX_DEPLOYMENT_TARGET=${{ env.MACOS_DEPLOYMENT_TARGET }}"
            echo "âœ… CIBW environment variables set: $CIBW_ENVIRONMENT_MACOS"
            
            # æ­¥éª¤8: æœ€ç»ˆéªŒè¯
            echo "Step 8: Final verification..."
            echo "ğŸ“‹ Final environment summary:"
            echo "  PATH: $PATH"
            echo "  FC: $FC"
            echo "  CC: $CC"
            echo "  CXX: $CXX"
            echo "  LDFLAGS: $LDFLAGS"
            echo "  CPPFLAGS: $CPPFLAGS"
            echo "  PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
            echo "  CIBW_ENVIRONMENT_MACOS: $CIBW_ENVIRONMENT_MACOS"
            
            # æœ€ç»ˆéªŒè¯gfortran
            echo "ğŸ” Final gfortran verification:"
            which gfortran
            gfortran --version
            echo "âœ… macOS build environment configured successfully!"
            echo "ğŸ” Final environment check:"
            echo "  MACOSX_DEPLOYMENT_TARGET: $MACOSX_DEPLOYMENT_TARGET"
            echo "  CIBW_ENVIRONMENT_MACOS: $CIBW_ENVIRONMENT_MACOS"
          
          # Windows: è®¾ç½®MSVCç¯å¢ƒ
          CIBW_BEFORE_BUILD_WINDOWS: |
            echo "ğŸ“¦ Setting up MSVC environment for Windows builds..."
            
            # è®¾ç½®ç¼–è¯‘å™¨ç¯å¢ƒå˜é‡
            export CC=cl
            export CXX=cl
            export FC=cl
            
            # è®¾ç½®Fortranç¼–è¯‘æ ‡å¿—
            export FFLAGS="/fpp /std:legacy"
            
            echo "âœ… Windows MSVC environment configured"
          
          # macOS: ä½¿ç”¨delocateä¿®å¤wheel
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: |
            echo "ğŸ”§ Repairing macOS wheel..."
            
            # æ£€æŸ¥delocateæ˜¯å¦å¯ç”¨
            if command -v delocate-wheel >/dev/null 2>&1; then
              echo "âœ… delocate found, using it to repair wheel"
            else
              echo "âš ï¸ delocate not found, trying to install it"
              pip install delocate
            fi
            
            # ç”¨delocateä¿®å¤wheel
            delocate-wheel -w {dest_dir} {wheel}
            
            echo "âœ… macOS wheel repaired with delocate"
          

      
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.cibw_archs }}
          path: ./wheelhouse/*.whl

  test_linux:
    name: Test Linux wheel (Python ${{ matrix.python-version }})
    needs: [setup, build_wheels]
    runs-on: ubuntu-latest
    if: always()
    strategy:
      matrix:
        python-version: ${{ fromJson(needs.setup.outputs.python-versions-test) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Linux wheels
        uses: actions/download-artifact@v4
        with:
          name: wheels-ubuntu-latest-x86_64
          path: ./wheels
        continue-on-error: true
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install wheel
        run: |
          echo "ğŸ” Available wheels:"
          ls -la ./wheels/ || echo "No wheels found"
          
          # æ ¹æ®Pythonç‰ˆæœ¬é€‰æ‹©å¯¹åº”çš„è½®å­
          python_short=$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")
          echo "ğŸ¯ Looking for wheel matching Python version: $python_short"
          
          target_wheel=$(ls ./wheels/*${python_short}*linux*.whl 2>/dev/null | head -1)
          
          if [ -n "$target_wheel" ] && [ -f "$target_wheel" ]; then
            echo "âœ… Found matching Linux wheel: $target_wheel"
            pip install "$target_wheel" -q
            echo "ğŸ“Š Installed wheel info:"
            pip show irssg
          else
            echo "âŒ No Linux wheel found for Python $python_short"
            echo "Available wheels:"
            ls -la ./wheels/ || echo "No wheels directory"
            exit 1
          fi

      - name: Test irssg functionality (Linux)
        run: |
          echo "=== LinuxåŠŸèƒ½æµ‹è¯• ==="
          cd examples/test_irssg
          ls -la  # æ˜¾ç¤ºå¯ç”¨æ–‡ä»¶
          
          # æµ‹è¯•åŸºæœ¬å‘½ä»¤
          irssg --version
          irssg --help
          
          # æµ‹è¯•éªŒè¯å‘½ä»¤
          irssg --validate
          
          # è¿›å…¥æµ‹è¯•ç›®å½•å¹¶è¿è¡Œ

          
          # æµ‹è¯•å®Œæ•´æ‰§è¡Œ
          timeout 30s irssg irssg.in || echo "irssg command completed (may have timed out or finished)"
          
          echo "âœ… All Linux tests passed"



  collect_wheels:
    name: Collect all wheels
    needs: [setup, build_wheels, test_linux]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      
      - name: List all built wheels
        run: |
          echo "ğŸ‰ æˆåŠŸæ„å»ºçš„wheels:"
          ls -la dist/
          echo ""
          echo "ğŸ“Š æ„å»ºç»Ÿè®¡:"
          echo "Total wheels: $(ls dist/*.whl | wc -l)"
          echo "Linux wheels: $(ls dist/*linux*.whl | wc -l)"
          echo "macOS wheels: $(ls dist/*macos*.whl | wc -l)"
          echo "Windows wheels: $(ls dist/*win*.whl | wc -l)"
      
      - name: Upload all wheels
        uses: actions/upload-artifact@v4
        with:
          name: all-wheels
          path: dist/*.whl

